# RAG Chat Service
A production-ready backend microservice built with Spring Boot for storing and managing chat histories generated by **Retrieval-Augmented Generation (RAG)** based chatbot systems

## 🚀 Features

- **Session Management**: Create, update, rename, favourite, and delete chat sessions
- **Message Storage**: Store and retrieve chat messages with sender information and optional context
- **JWT Authentication**: Secure user authentication using JWT tokens
- **API Key Protection**: Service-level authentication via API keys
- **Rate Limiting**: Redis-based rate limiting to prevent API abuse
- **Event Streaming**: Kafka integration for async event processing and audit trails
- **Caching**: Redis caching for improved performance
- **Pagination**: Support for paginated responses
- **Health Checks**: Sprint Actuator endpoints for monitoring
- **API Documentation**: Interactive Swagger/OpenAPI documentation
- **CORS Support**: Configurable CORS for cross-origin requests
- **Global Error Handling**: Centralized exception handling with detailed error responses
- **Comprehensive Logging**: Structured logging with Logback

## 🏗️ Architecture

```
rag-chat-storage/
├── src/
│   ├── main/
│   │   ├── java/com/ragchat/storage/
│   │   │   ├── RagChatStorageApplication.java
│   │   │   ├── config/
│   │   │   │   ├── SecurityConfig.java
│   │   │   │   ├── RedisConfig.java
│   │   │   │   ├── KafkaConfig.java
│   │   │   │   ├── SwaggerConfig.java
│   │   │   │   └── CorsConfig.java
│   │   │   ├── controller/
│   │   │   │   ├── SessionController.java
│   │   │   │   ├── MessageController.java
│   │   │   │   └── HealthController.java
│   │   │   ├── service/
│   │   │   │   ├── SessionService.java
│   │   │   │   ├── MessageService.java
│   │   │   │   ├── KafkaProducerService.java
│   │   │   │   └── RateLimitService.java
│   │   │   ├── repository/
│   │   │   │   ├── SessionRepository.java
│   │   │   │   └── MessageRepository.java
│   │   │   ├── model/
│   │   │   │   ├── ChatSession.java
│   │   │   │   ├── ChatMessage.java
│   │   │   │   └── SenderType.java
│   │   │   ├── dto/
│   │   │   │   ├── SessionRequest.java
│   │   │   │   ├── SessionResponse.java
│   │   │   │   ├── MessageRequest.java
│   │   │   │   ├── MessageResponse.java
│   │   │   │   └── ErrorResponse.java
│   │   │   ├── security/
│   │   │   │   ├── JwtUtil.java
│   │   │   │   ├── JwtAuthenticationFilter.java
│   │   │   │   └── ApiKeyFilter.java
│   │   │   └── exception/
│   │   │       ├── GlobalExceptionHandler.java
│   │   │       ├── SessionNotFoundException.java
│   │   │       ├── RateLimitExceededException.java
│   │   │       └── UnauthorizedException.java
│   │   └── resources/
│   │       ├── application.yml
│   │       └── logback-spring.xml
│   └── test/
│       └── java/com/ragchat/storage/
│           ├── service/
│           │   ├── SessionServiceTest.java
│           │   └── MessageServiceTest.java
│           └── controller/
│               └── SessionControllerTest.java
├── docker-compose.yml
├── Dockerfile
├── pom.xml
├── .env.example
├── .gitignore
└── README.md
```

## 🛠️ Technology Stack

- **Framework**: Spring Boot 3.2.0
- **Language**: Java 17
- **Database**: MySQL 8.0
- **Cache & Rate Limiting**: Redis 7
- **Message Broker**: Apache Kafka
- **Authentication**: JWT (JSON Web Tokens)
- **API Documentation**: SpringDoc OpenAPI (Swagger)
- **Build Tool**: Maven
- **Containerization**: Docker & Docker Compose


## 📋 Prerequisites

- Docker and Docker Compose installed
- Java 17+ (for local development without Docker)
- Maven 3.6+ (for local development without Docker)


## 🚀 Quick Start

### 1. Clone the Repository

```bash
git clone <repository-url>
cd rag-chat-storage
```

### 2. Environment Setup

Copy the backend environment template:
```bash
cp .env.example .env
```

Edit `.env` file with your backend configuration:
```env
DB_PASSWORD=your-secure-password
DB_USERNAME=root
API_KEY=your-secure-api-key
JWT_SECRET=your-256-bit-secret-key-minimum-32-characters
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_DURATION=60
```

### 3. Start Services with Docker

```bash
# Start all services (MySQL database (port 3306) , Redis cache (port 6379), Kafka with Zookeeper (port 9092), Adminer database management tool (port 8081), Spring Boot application (port 8080))
docker-compose up -d

# Check services status
docker-compose ps

# View logs
docker-compose logs -f api
```

### 4. Verify Installation

- **API**: http://localhost:8080
- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **Health Check**: http://localhost:8080/actuator/health
- **Adminer** (DB Management): http://localhost:8081

## 📚 API Documentation

### Base URL
```
http://localhost:8080
```

### Authentication
All endpoints require an API key in the header:
```
X-API-Key: my-super-secure-api-key-change-me-12345
```

### 📁 Session Management

#### Create Session
```
curl --location 'http://localhost:8080/api/sessions' \
--header 'X-API-Key: my-super-secure-api-key-change-me-12345' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--header 'Content-Type: application/json' \
--data '{
     "sessionName": "Technical Discussion"
   }'

```

#### List Sessions
```
curl --location 'http://localhost:8080/api/sessions?page=0&size=10&sortBy=updatedAt&direction=DESC' \
--header 'X-API-Key: {{token}}' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU'
```

#### Get Session
```
curl --location 'http://localhost:8080/api/sessions/1' \
--header 'X-API-Key: {{token}}' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU'
```

#### Update Session
```
curl --location --request PUT 'http://localhost:8080/api/sessions/1' \
--header 'X-API-Key: {{token}}' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--header 'Content-Type: application/json' \
--data '{
     "sessionName": "Updated Technical Discussion"
   }'
```

#### Toggle Favorite
```
curl --location --request PATCH 'http://localhost:8080/api/sessions/1/favorite' \
--header 'X-API-Key: {{token}}' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--header 'Content-Type: application/json' \
--data '{
     "id": 1,
     "userId": "test-user-123",
     "sessionName": "Updated Technical Discussion",
     "isFavorite": true,
     "createdAt": "2024-01-15T10:30:00",
     "updatedAt": "2024-01-15T10:36:00",
     "messageCount": 0
   }'
```

#### Delete Session
```
curl --location --request DELETE 'http://localhost:8080/api/sessions/1' \
--header 'X-API-Key: my-super-secure-api-key-change-me-12345' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--data ''
```

#### Get Favorite Sessions
```
curl --location 'http://localhost:8080/api/sessions/favorites?page=0&size=10' \
--header 'X-API-Key: my-super-secure-api-key-change-me-12345' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU'
```

### 💬 Message Management

#### Add Message
```
curl --location 'http://localhost:8080/api/sessions/1/messages' \
--header 'X-API-Key: my-super-secure-api-key-change-me-12345' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--header 'Content-Type: application/json' \
--data ' {
     "sender": "USER",
     "content": "What is Spring Boot?",
     "context": "User asking about Spring Boot framework"
   }'
```

#### Get Messages (Paginated)
```http
curl --location --request GET 'http://localhost:8080/api/sessions/1/messages?page=0&size=20&direction=ASC' \
--header 'X-API-Key: my-super-secure-api-key-change-me-12345' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--header 'Content-Type: application/json' \
--data ' {
     "sender": "USER",
     "content": "What is Spring Boot?",
     "context": "User asking about Spring Boot framework"
   }'
```

### 🤖 Chat with AI

#### Send Chat Message
```
curl --location 'http://localhost:8080/api/sessions/1/messages' \
--header 'X-API-Key: my-super-secure-api-key-change-me-12345' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0dXNlcjEyMyIsImlhdCI6MTc2MTQ3MjQ3NiwiZXhwIjoxNzYxNTU4ODc2fQ.QXHNQvba_73UpBORI0OT_F3cz_p8LlsYomqHP-_47sU' \
--header 'Content-Type: application/json' \
--data '{
     "sender": "AI",
     "content": "Spring Boot is a framework that makes it easy to create stand-alone, production-grade Spring-based applications. It provides auto-configuration and embedded servers.",
     "context": "Retrieved from Spring documentation database"
   }'
```


### 📄 Document Management

## 📊 System Endpoints

#### Health Check
```
curl --location 'http://localhost:8080/actuator/health'
```

**Response:**
```json
{
    "status": "UP"
}
```

## 🔧 Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DB_URL` | MySQL connection string | Required |
| `DB_USERNAME` | MySQL username | Required |
| `DB_PASSWORD` | MySQL password | Required |
| `REDIS_HOST` | Redis host name | Required |
| `REDIS_PORT` | Redis Port | Required |
| `KAFKA_BOOTSTRAP_SERVERS` | Kafka bootstrap server URL | Required |
| `API_KEY` | Api Key for Authentication | Required |
| `JWT_SECRET` | JWT token | Required |
| `RATE_LIMIT_REQUESTS` | How many requests are allowed | Required |
| `RATE_LIMIT_DURATION` | How many requests are allowed in this duration | Required |
| `SHOW_SQL` | Logging purpose | Required |


### Database Configuration

Access Adminer at http://localhost:8081
- **System**: MySQL
- **Server**: mysql
- **Username**: root
- **Password**: (from your .env file)
- **Database**: chatdb


## 📝 Logging

Logs are stored in the `logs/` directory:
- Application logs: `logs/rag-chat-storage.log`
- Logs rotate daily and are kept for 30 days

View real-time logs:

```bash
docker-compose logs -f app
```


## 🔒 Security Best Practices

1. **Change Default Credentials**: Always change API_KEY and JWT_SECRET in production
2. **Use Strong Secrets**: Use at least 256-bit secrets for 
3. **Rate Limiting**: Adjust rate limits based on your requirements
4. **CORS**: Configure specific allowed origins in production

## 🚀 Production Deployment

### Building for Production

```bash
mvn clean package -DskipTests
```

### Running the JAR

```bash
java -jar target/rag-chat-storage-1.0.0.jar
```

## 🐛 Troubleshooting

### Services won't start

```bash
docker-compose down -v
docker-compose up -d
```

### Check service logs

```bash
docker-compose logs mysql
docker-compose logs redis
docker-compose logs kafka
docker-compose logs app
```

### Database connection issues

Ensure MySQL is fully started before the application:

```bash
docker-compose up -d mysql
# Wait for MySQL to be healthy
docker-compose up -d app
```

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

